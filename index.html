<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Night</title>
  <style>
    :root { --bg:#0b0c10; --card:#14161d; --muted:#a6adbb; --text:#e8eefc; --line:#2a2f3a; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 600px at 20% 0%, #17203a 0%, var(--bg) 60%);
      color:var(--text);
    }
    header{ padding:24px 18px 8px; max-width:1100px; margin:0 auto; }
    h1{ margin:0; font-size:28px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color:var(--muted); }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; display:grid; gap:16px; }
    .panel{
      background: rgba(20,22,29,.9);
      border:1px solid rgba(42,47,58,.9);
      border-radius:16px; padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select{
      background:#0f1117; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; outline:none; min-width:180px;
    }
    input:focus, select:focus{ border-color:#5b86ff; box-shadow:0 0 0 3px rgba(91,134,255,.18); }
    button{
      background:#5b86ff; color:#071022;
      border:0; padding:10px 14px; border-radius:12px;
      cursor:pointer; font-weight:650;
    }
    button.secondary{ background:#222838; color:var(--text); border:1px solid var(--line); }
    button.danger{ background:#ff5b73; color:#1a070b; }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 900px){ .grid{ grid-template-columns:1fr 1fr; } }
    .colhead{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin:2px 0 12px; }
    .colhead h2{ margin:0; font-size:18px; }
    .count{ color:var(--muted); font-size:12px; }
    .list{ display:grid; gap:10px; }
    .item{
      border:1px solid var(--line); border-radius:14px;
      padding:12px; background: rgba(15,17,23,.7);
      display:grid; gap:8px;
    }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .title{ font-weight:750; }
    .meta{ color:var(--muted); font-size:13px; line-height:1.3; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    a{ color:#9db6ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .watched .title{ text-decoration: line-through; opacity:.23; }
    .watched{ opacity:.40; }
    footer{ max-width:1100px; margin:0 auto; padding:6px 18px 22px; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>üçø Movie Night</h1>
    <p class="sub">Grab the popcorn</p>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="topbar">
        <div>
          <label for="owner">Add to</label>
          <select id="owner">
            <option value="raul">Raul's Movies</option>
            <option value="roxi">Roxi's Movies</option>
          </select>
        </div>
		 <div style="flex:1; min-width:220px;">
          <label for="imdb">IMDb id</label>
          <input id="imdb" placeholder="e.g. tt0032599" />
        </div>
        <div style="flex:1; min-width:220px;">
          <label for="notes">Notes (optional)</label>
          <input id="notes" placeholder="e.g. sci-fi / slow burn / 2016" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="addBtn">Add</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="secondary" id="clearWatchedBtn" title="Remove watched movies from both lists">Clear watched</button>
        </div>
      </div>
    </section>

    <section class="grid">
      <section class="panel">
        <div class="colhead">
          <h2>Raul's Movies</h2>
          <div class="count" id="countRaul"></div>
        </div>
        <div class="list" id="listRaul"></div>
      </section>

      <section class="panel">
        <div class="colhead">
          <h2>Roxi's Movies</h2>
          <div class="count" id="countRoxi"></div>
        </div>
        <div class="list" id="listRoxi"></div>
      </section>
    </section>
  </main>

<script>
  const STORAGE_KEY = "movie-night-v1";
  const OMDB_API_KEY = "fb7bedc5";

  /** @type {{id:string, owner:"raul"|"roxi", title:string, notes?:string, link?:string, watched:boolean, createdAt:number}[]} */
  let movies = load();

  const $ = (id) => document.getElementById(id);

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }catch{
      return [];
    }
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(movies));
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function normalizeUrl(url){
    const t = (url || "").trim();
    if(!t) return "";
    // If user didn't include protocol, assume https
    if(/^https?:\/\//i.test(t)) return t;
    return "https://" + t;
  }

 async function addMovie(){
  const owner = $("owner").value;
  const notes = $("notes").value.trim();
  const imdbInput = $("imdb").value.trim();

  const imdbId = extractImdbId(imdbInput);
  if(!imdbId){
    alert("Please add a valid IMDb ID or link.");
    $("imdb").focus();
    return;
  }

  const imdbData = await fetchMovieFromImdb(imdbId);
  if(!imdbData || !imdbData.title){
    alert("Could not fetch movie from IMDb.");
    return;
  }

  const movie = {
    id: uid(),
    owner,
    title: imdbData.title,
    notes: notes || " ",
	imdbInfo:`${imdbData.year} ‚Ä¢ ${imdbData.genre}`,
    imdbId,
    posterUrl: imdbData.posterUrl,
    watched: false,
    createdAt: Date.now()
  };

  movies.unshift(movie);
  save();
  render();

 
  $("notes").value = "";
  $("imdb").value = "";
}

  function toggleWatched(id){
    const m = movies.find(x => x.id === id);
    if(!m) return;
    m.watched = !m.watched;
    save();
    render();
  }

  function removeMovie(id){
    movies = movies.filter(x => x.id !== id);
    save();
    render();
  }

  function clearWatched(){
    movies = movies.filter(x => !x.watched);
    save();
    render();
  }

  function render(){
    const raul = movies.filter(m => m.owner === "raul");
    const roxi = movies.filter(m => m.owner === "roxi");

    $("countRaul").textContent = `${raul.length} total`;
    $("countRoxi").textContent = `${roxi.length} total`;

    $("listRaul").innerHTML = raul.length ? raul.map(cardHtml).join("") : emptyHtml("No movies yet ‚Äî add one above.");
    $("listRoxi").innerHTML = roxi.length ? roxi.map(cardHtml).join("") : emptyHtml("No movies yet ‚Äî add one above.");

    // wire buttons after render
    document.querySelectorAll("[data-toggle]").forEach(btn => {
      btn.addEventListener("click", () => toggleWatched(btn.dataset.toggle));
    });
    document.querySelectorAll("[data-remove]").forEach(btn => {
      btn.addEventListener("click", () => removeMovie(btn.dataset.remove));
    });
  }

  function emptyHtml(msg){
    return `<div class="item"><div class="meta">${escapeHtml(msg)}</div></div>`;
  }
  
  
  function extractImdbId(input){
		const t = (input || "").trim();
		if(!t) return "";
		// match tt1234567 anywhere in the string
		const m = t.match(/tt\d{7,8}/);
		return m ? m[0] : "";
	}
	
  async function fetchMovieFromImdb(imdbId){
	if(!imdbId || !OMDB_API_KEY) return null;

	const url = `https://www.omdbapi.com/?i=${encodeURIComponent(imdbId)}&apikey=${encodeURIComponent(OMDB_API_KEY)}`;
	const res = await fetch(url);
	if(!res.ok) return null;

	const data = await res.json();
	if(data.Response === "False") return null;

	return {
		title: data.Title || "",
		posterUrl: data.Poster && data.Poster !== "N/A" ? data.Poster : "",
		year: data.Year || "",
		runtime: data.Runtime || "",
		genre: data.Genre || ""
	};
}

  function cardHtml(m){
  const img = m.posterUrl
    ? `<img src="${escapeAttr(m.posterUrl)}" alt="" style="width:70px;height:105px;object-fit:cover;border-radius:10px;border:1px solid var(--line);" />`
    : "";

  const notes = m.notes ? `<div class="meta">${escapeHtml(m.notes)}</div>` : "";
  const imdb = m.imdbId ? `<div class="meta"><a href="https://www.imdb.com/title/${escapeAttr(m.imdbId)}/" target="_blank" rel="noopener">IMDb</a></div>` : "";
  const imdbInfo = m.imdbInfo ? `<div class="meta">${escapeHtml(m.imdbInfo)}</div>` : "";

  return `
    <div class="item ${m.watched ? "watched" : ""}">
      <div class="row">
        <div style="display:flex; gap:12px;">
          ${img}
          <div>
            <div class="title">${escapeHtml(m.title)}</div>
            ${notes}
			${imdbInfo}
            ${imdb}
          </div>
        </div>
        <div class="actions">
          <button class="secondary" data-toggle="${m.id}">${m.watched ? "Unwatch" : "Watched"}</button>
          <button class="danger" data-remove="${m.id}">Delete</button>
        </div>
      </div>
    </div>
  `;
}
  
  

  function escapeHtml(s){
    return (s || "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s){
    return escapeHtml(s).replace(/"/g, "&quot;");
  }

  $("addBtn").addEventListener("click", () => addMovie());
  $("imdb").addEventListener("keydown", (e) => { if(e.key === "Enter") addMovie(); });
  $("clearWatchedBtn").addEventListener("click", clearWatched);

  render();
</script>
</body>
</html>